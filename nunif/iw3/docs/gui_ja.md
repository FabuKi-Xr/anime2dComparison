# iw3-gui

iw3-guiは実写のあらゆる画像・動画を3D画像・3D動画に変換するソフトウェアです。
VRで本当に見たかった画像・動画をVRデバイスで3Dメディアとして見れるようになります。

インストールについては[nunif windows package](../../windows_package/docs/README_ja.md)を参照してください。

![iw3-gui-ja](https://github.com/nagadomi/nunif/assets/287255/effa24e4-5b68-43dd-bd7a-24d015d6b743)

このソフトウェアはよい設定値が入力に依存していて調節が難しいソフトウェアです。前半に各項目の説明を記述して、後半に応用的な説明を記述します。

処理の概要は以下です。

- 入力画像（動画フレーム）から深度(各ピクセルの奥行き)を推定します
- 入力画像と推定した深度からステレオ画像(左右それぞれの目に映す画像)を生成します

## 入力

処理対象のファイルまたはフォルダを選択します。最初のボタンが`ファイル選択`で、次のボタンが`フォルダ選択`です。ファイルひとつの場合はドラッグアンドドップもできます。

フォルダを選択した場合はフォルダ直下の画像ファイルと動画ファイルが対象になります。

`処理を再開`にチェックをつけるとすでに出力が存在するファイルをスキップします。

`すべてのサブフォルダを処理`にチェックをつけると指定フォルダより下の階層にあるすべてのファイルが対象になります。ただし出力フォルダ内は除外されます。
指定したフォルダによっては非常に多くのファイルが対象になるので注意してください。

再生ボタンをクリックすると選択したファイルまたはフォルダが表示されます。

## 出力

出力フォルダを選択します。

入力がファイルの場合は出力ファイル名を直接入力することもできます。画像の場合は`.jpg, .png, webp`、動画の場合は`.mp4`の拡張子を使用してください。
またVRで3Dメディアとして認識させるために[ファイル名ルール](#ファイル名ルール)も必要です。

`同じフォルダを設定`ボタンでは、入力と同じフォルダの下に`iw3`フォルダを作ってそこに出力します。

再生ボタンをクリックすると出力結果があればそれを表示します。なければ出力フォルダを表示します。

## ステレオ生成

3D化の設定です。

### 3Dの強さ

奥行きの強さ(深さ)です。

![divergence](https://github.com/nagadomi/nunif/assets/287255/2bf3984e-a125-45f3-bd17-4b16ab467072)

(`--divergence`がこの設定値です)

基本は`2.0`です。大きくするほど立体感が出ますが、ゴーストアーティファクトが発生しやすくなります。ゴーストアーティファクトは、深度の差が大きいところに発生するノイズのようなものです。人物と背景の境界が2重に見えて焦点が合わせづらくなります。

### 収束平面

スクリーンに対する3Dの奥行きが出る位置・方向です。この設定値は好みや視覚のクセが関わるのでいくつか試してよい設定を見つけてください。

![convergence](https://github.com/nagadomi/nunif/assets/287255/7d80f540-5f8d-4c6d-86ce-985e524fdea9)

(`--convergence`がこの設定値です)

`0`では、スクリーン位置から前に向かって表示されます。おそらくもっとも一般的な設定です。ただし、スクリーンの端のほうで左右の目で見える範囲が変わるので焦点が合わせづらくなります。

`1`では、スクリーン位置から奥に向かって表示されます。おそらくもっとも問題の発生しない設定です。曲面スクリーンにも適しています。ただし、表示位置が遠くみえます。

`0.5`は、`0`と`1`の中間です。デフォルト値ですが、よい設定値ではないと思います。

### 自分の大きさ

スクリーンに対する自分の大きさです。

![ipd-offset](https://github.com/nagadomi/nunif/assets/287255/a1001307-8c07-457c-a2a8-f0548e0d072c)

(`--ipd-offset`がこの設定値です)

人物を等身大で見たい等の理由で細かく調節するモチベーションがある場合に調節してください。

VR Player側で設定できる場合もあります。通常は0を選択してください。

### メソッド

深度からステレオ画像を生成する手法です。

`row_flow`は機械学習モデルによる方法です。通常はこれを使ってください。
このモデルは、`3Dの強さ` 0〜2.5, 画像の横幅1920pxの範囲でしか学習されていません。それ以上でも動作はしますが、よくない結果になるかもしれません。

`grid_sample`は、単純な計算式による方法です。どんな設定値でも同じように動作し、非常に高速です。ただし、ゴーストアーティファクトが発生します。開発・実験用です。

### 深度推定モデル

深度を推定する学習済みモデルを指定します。

深度推定には[ZoeDepth](https://github.com/isl-org/ZoeDepth)をForkして使用しています。

通常は`ZoeD_N`を選択してください。
`ZoeD_N`は屋内シーンのデータで調節されたモデルです。
`ZoeD_K`は、屋外シーンのデータで調節されたモデルですが、屋外シーンというのがドライブレコーダーの映像です。

### 深度の割当

深度を再マッピングする関数を指定します。通常は`pow2`(深度の二乗)を指定してください。

人物の屋外シーンなどで、人物の奥行きが圧縮されて平面に見える場合は、`softplus2`を選択してください。`softplus2`では、遠くほど立体感をなくしてその分の立体感を近い方に割り当てます。

### フォーマット

出力形式を指定します。またVR動画プレイヤーにメディアの形式を認識させるためにファイル名にそれぞれ識別子を追加します。[ファイル名ルール](#ファイル名ルール)

`Full SBS`は、フル解像度のサイド・バイ・サイドです。

`Half SBS`は、ハーフ解像度のサイド・バイ・サイドです。画像の横幅が半分に圧縮されます。古いVR機器ではこのフォーマットしかサポートしていないことがあります。

`VR90`は、正面90°のみを描画したVR180フォーマット(Equirectangular)です。再生時の操作が制限されるので通常はオススメしません。使用しているVR機器や投稿サイト等の都合で使いたい場合に指定してください。

### ちらつきを軽減

フレーム間での深度のちらつきを減らします。個人的には、違いが分からないのと副作用もあるのででオススメしませんが、目がよくて深度のちらつきが気になることがあれば試してみてください。動画のみに影響します。

## 背景除去

背景を除去した画像から深度を推定します。

屋外シーン等で人物が平面に見える場合に使用すると修正できる場合があります。写真に対して細かく設定を調節するモチベーションがあるときに使用してみてください。

## 動画圧縮

動画出力時の設定です。主にlibx264の設定です。
より詳しい情報は https://trac.ffmpeg.org/wiki/Encode/H.264 を参照してください。

### 最大フレームレート

動画のフレームレート(一秒間のフレーム数)が最大フレームレートを超えているときは最大フレームレートに制限します。
超えていないときはオリジナルの（平均）フレームレートで出力します。

デフォルトで30FPSに制限されていることに注意してください。

### CRF

品質設定です。**小さい値**ほど品質が高くファイルサイズが大きくなります。

### プリセット

処理速度と圧縮率のバランスを決めるオプションです。
遅い設定のほうが圧縮率が高くファイルサイズが小さくなります。

### チューニング

入力にあった設定のセットを使用できます。

- `animation`: アニメ
- `film`: 映画 実写
- `stillimage`: スライドショー
- `grain`: アナログフィルム (粒子状ノイズの維持）
- `fastdecode`: いくつかのフィルタを無効にすることで再生時の負荷を減らします
- `zerolatency`: シークが速くなります。

よくわからない場合は選択しません。

## ビデオフィルタ

動画の追加処理です。

### 開始時間, 終了時間

入力動画内の処理する時間範囲を指定します。指定された時間範囲のみ出力します。
チェックを付けなければすべて処理されます。

### デインターレース

入力ストリームに対してデインターレースフィルタを適用します。インターレース方式の動画に使用します。
（動画に細かい横線が点滅するやつを消します）

現在は、yadifが選択できます。
他のフィルタやより高度なオプションを使いたい場合は、下記のvfオプションを使用してください。

## vf

入力動画ストリームに対してffmpegのビデオフィルター(-vfオプション)を適用します。この処理は深度推定よりも前に適用されます。

ブランチを含む複雑な式は動作しません。`フィルタ名1,フィルタ名2=パラメータ1:パラメータ2,...`形式の直列な式のみ対応しています。パラメータ内の`,`は`\,`にエスケープしてください。
式の解析が独自実装なのでうまくいかない式があるかもしれません。

## 回転

入力フレームを90°回転させます。スマホで撮影した動画など横向きになっている動画を処理前に修正する機能です。

## パディング

出力フレーム内に黒の余白を追加します。通常はオススメしません。
人物サイズやスクリーンの表示位置など細かく調節したい場合に使用してください。

## 出力サイズ制限

出力サイズを指定解像度内に制限します。スマホを使ったCardboard(安価なVRメガネ)で、解像度の大きい動画が再生できない場合に使用してください。

`アスペクト比を維持`にチェックがない場合は、指定されたサイズにフィットするようにリサイズします。VRプレイヤー側でアスペクト比を修正できる場合にチェックを外します。

## プロセッサ

計算に関連する設定です。

### デバイス

計算に使用するGPUまたはCPUを指定します。

GPUにはCUDAに対応しているグラフィックボードが表示されます。事実上NVIDIA製になります。

CPUでも動作はしますが、信じがたい遅さになります。

### 深度解像度

深度推定時の解像度を上げることができます。ただし、モデル自体が高解像度に対応していないため、結果がよくなるかは分かりません。縦長の画像はデフォルトで大きめの解像度で計算されているので効果はありません。

### 深度バッチサイズ

深度推定を同時に処理するフレーム数です。主に動画用です。画像は1フレームなので基本的には1で処理されます（TTAを使ったときは最大で2になります）。

一般的には、大きい値ほど多くのVRAM(グラフィックボードのメモリ)を使用して処理が速くなります。環境によっては小さい値のほうが速いこともあります。

VRAMが少ないGPUでは小さい値にしないとメモリ不足エラーになります。

### ステレオバッチサイズ

ステレオ生成時のブロックを同時に処理する数です。内部的に256x256のブロックに分割して処理しています。

一般的には、大きい値ほど多くのVRAMを使用して処理が速くなります。環境によっては小さい値のほうが速いこともあります。

### 低ビデオメモリ

すべての条件下で深度バッチサイズを1に制限にします。どうやってもVRAMのメモリ不足になる場合に試してみてください。

### TTA

深度推定を左右反転してた2パターンの画像に対して行い結果を平均して品質を改善します。ただし処理時間が2倍になります。

### FP16

計算に半精度浮動小数点(16bit float)を使用します。
Turing(RTX20シリーズ)以降のGPUでは有効にすることで処理が速くなりVRAMの使用量が減ります。

古いGPUでは遅くなったりエラーになったりするかもしれません。その場合はOFFにできます。

## 開始・キャンセル

`開始`ボタンで処理を開始します。`キャンセル`ボタンで実行中の処理をキャンセルします。

# 応用

## VR動画プレイヤー

Meta Quest 2上の以下の2つのソフトウェアで動作確認しています。

### Pigasus VR Media Player

Pigasusは、3D動画、3D画像、SMB(共有ドライブ)すべてで完璧に動作します。
ただし、個人的にはUIや操作があまり好きではありません。

もしソフトがひとつしか選べないならこれをオススメします。

### SKYBOX VR Video Player

このUIは気に入っています。
ただし、たくさんの問題があります。

- SMB(共有ドライブ)からの画像の読み込み対応していません
- Full SBS動画が正しいアスペクト比で再生できません
- FPSが低い動画でシークが正しく動作しません

一番の問題であるアスペクト比は、4:3や16:9など一般的なアスペクト比であればメニューから手動で修正できます。またHalf SBSで出力すると正しいアスペクト比で再生できます。

## ファイル名ルール

VR動画プレイヤーはファイル名によってメディアの形式を認識しています。

ファイル名の末尾に以下の識別子をつけると正しいフォーマットで認識されます。

- `_LRF`: Full SBS
- `_LR`: Half SBS
- `_180x180_LR`: VR180 (VR90)

出力にフォルダを指定した場合、上記の識別子が自動で追加されます。ファイル名を直接指定する場合は、手動で追加してください。

## トラブルシューティング

### 前景(人物)が平面になる

屋外シーンの写真で発生しやすいです。

この問題と戦ういくつかの方法があります。

- `深度割当`に`softplus2`を指定する
- `背景除去`を有効にする
- それらの組み合わせ

この問題の原因のひとつは、iw3ではあらゆるシーンを同じ厚さ内に表示していることです。
壁まで2メートルのシーンと空が宇宙まで続いているシーンでは、人物の厚みに使える範囲が大きく変わります。
iw3では、遠くほど厚みを無くしてその分を近くに割り当てることでこの問題を軽減していますが、汎用的な設定では限界があります。

`深度割当`に`softplus2`を指定すると、デフォルトの`pow2`よりもさらに強く遠くほど厚みをなくしてその分を近くに割り当てます。

`背景除去`を行うと背景の距離が無くなるのでうまくいけば距離の問題が完全に解決します。ただし背景除去の精度の問題があり、複雑なシーンでは人物の切り抜きがうまくいきません。何が前景で何が背景なのかという問題もあります。

もうひとつの原因は深度推定モデルが人物のデータで学習されていないことで、これは設定の調節では解決できません。

### 動画エンコード・デコードエラー

フォーマットをissueに投稿してもらえれば解決できるかもしれません。
単純にファイルが壊れている場合は、他の方法で修正してください。

### 巨人!!

これはSBS 3D動画では原寸大を表現できないという根本的な問題です。

写真やシーンが動かない動画では、手動でサイズ感を調節できます。

- VR動画プレイヤーの設定で調節
- `自分の大きさ`で調節
- `パディング`で調節
- 組み合わせ

SKYBOX Playerでは、`3D Effect`を-0.3などマイナス側に動かすと対象が小さく見えます。

Pigasusでは、`設定 > 高度な設定 > IPD`のスライダーを大きくすると対象が小さく見えます。またトリガーボタンをダブルクリックすると画像内の一部を拡大・移動できます。

`自分の大きさ`設定では、それらよりも更に小さくできます。
ただし、小さくするほど厚みがなくなります。この場合、`3Dの強さ`を大きくできますが、大きくしぎるとゴーストアーティファクトが発生します。

また曲面スクリーンを使っているとサイズが大きく見えるので注意してください。

また`収束平面`が`0`と`1`では大きさの見え方も変わるので注意してください。`1`のほうが大きく見えます。

### CUDA Out of Memory

GPUのメモリ不足です。`深度バッチサイズ`を小さくするか`低VRAM`を有効にしてみてください。

また一度のこのエラーになると再度発生しやすくなるかもしれません。一度プログラムを終了してみてください。

作者はこのソフトウェアをRTX 3070 Ti(8GB VRAM, Linux)とGTX 1050 Ti(4GB VRAM, ノートPC, Windows)で動作確認していますが、どちらもデフォルトの設定で動作しています。

ちなみに上記の環境では、RTX 3070 TiのマシンがGTX 1050 Tiのマシンの10倍速いので、もしこのソフトウェアを気に入って古いGPUを使っている場合はRTX 3070 Ti以上の購入をオススメします。10時間かかる動画変換処理が1時間で終わるかもしれません。（OSや本体の違いもあるので言い切ることはできません）
